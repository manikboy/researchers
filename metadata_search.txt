USE [TM_ETL]
GO

/****** Object:  StoredProcedure [dbo].[USP_filesystem_ETL_SEARCH_TEXT_MOD]    Script Date: 3/7/2019 8:03:52 PM ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO


CREATE PROCEDURE [dbo].[USP_filesystem_ETL_SEARCH_TEXT_MOD]
@SEARCHTEXT VARCHAR(200)
AS
BEGIN
---this procedure searches for objects in TMBI,ETLPROD,SCOA
	SET NOCOUNT  ON;
	DECLARE @P_SEARCHTEXT VARCHAR(200)	= @SEARCHTEXT
	DECLARE @SQL VARCHAR(max)

	IF OBJECT_ID('TEMPDB..#TEMP_ETL') IS NOT NULL
	DROP TABLE #TEMP_ETL;

	CREATE TABLE #TEMP_ETL
	(
	ID INT IDENTITY(1,1),
	DATABASE_NAME VARCHAR(200),
	PROCEDURENAME VARCHAR(200)
	)

	SET @SQL = 
	'SELECT DISTINCT DB_NAME() DBNAME,
			O.NAME AS OBJECT_NAME 
	 FROM SYS.sql_modules(NOLOCK) M INNER JOIN SYS.OBJECTS(NOLOCK) O
		ON M.object_id = O.object_id
	WHERE M.definition LIKE ''%'+ @P_SEARCHTEXT +'%'''

	--TO FIND THE SEARCH REFERRED IN SQL SERVER PROCEDURES
	INSERT INTO #TEMP_ETL(DATABASE_NAME,PROCEDURENAME)
	EXEC (@SQL)

	

	--print @sql

	--TO FIND THE REFERENCED STRING IN TMBI 

	SET @SQL = 'select * from openquery(NETEZZA_PROD,''select DISTINCT database,procedure from _v_procedure WHERE UPPER(PROCEDURESOURCE) LIKE ''''%' + UPPER(@P_SEARCHTEXT) +'%'''' or  UPPER(PROCEDURE) LIKE ''''%' + UPPER(@P_SEARCHTEXT) +'%'''''')'

	INSERT INTO #TEMP_ETL(DATABASE_NAME,PROCEDURENAME)
	exec(@sql)

	--print @sql

	SET @SQL = 'select * from openquery(NETEZZA_PROD,''select DISTINCT database,VIEWNAME from _v_view WHERE UPPER(DEFINITION) LIKE ''''%' + UPPER(@P_SEARCHTEXT) +'%'''' or  UPPER(VIEWNAME) LIKE ''''%' + UPPER(@P_SEARCHTEXT) +'%'''''')'

	INSERT INTO #TEMP_ETL(DATABASE_NAME,PROCEDURENAME)
	exec(@sql)

	IF OBJECT_ID('TEMPDB..#TEMP_ETL_LOAD') IS NOT NULL
	DROP TABLE #TEMP_ETL_LOAD;

	CREATE TABLE #TEMP_ETL_LOAD
	(
	NAME VARCHAR(500),
	--DESCRIPTION VARCHAR(500),
	PACKAGEDATA XML
	)

	SELECT * FROM #TEMP_ETL

	DECLARE @INCREMENTOR INT = 1

	DECLARE @LIMIT INT
	
	SELECT @LIMIT = MAX(ID) FROM #TEMP_ETL
	
	WHILE @INCREMENTOR <= @LIMIT
	BEGIN

	SELECT @P_SEARCHTEXT = PROCEDURENAME FROM #TEMP_ETL WHERE ID = @INCREMENTOR
	--DECLARE @SEARCHTXT varchar(200)='text'
	--DECLARE @SQLl varchar(max)
	set @sql = 'select etl_name,
	packagedata
	 from dbo.tbl_filesystem_etls
	 where cast(packagedata as nvarchar(max)) like  ''%'+ @P_SEARCHTEXT +'%'''
	 --print(@SQL)

	 INSERT INTO #TEMP_ETL_LOAD(NAME,  PACKAGEDATA)
	 exec (@sql)

	 SET @INCREMENTOR = @INCREMENTOR + 1;

	 END

	 SELECT * FROM #TEMP_ETL_LOAD

	
END
GO


